#!/bin/sh

# This script downloads list of Sony-Ericsson phones from web and
# prepares list suitable for common/gsmphones.c

tmp=$(dirname $0)/se-list
if [ ! -f "$tmp" ]; then
  URL=https://web.archive.org/web/20120620054856/http://homepage.mac.com:80/alvinmok/ericsson/types.html
  wget -O - "$URL" | tr '\r' '\n' > "$tmp"
fi

awk 'BEGIN { p = 0; }
/Type code orderin/ { p = 1; }
/<tr><th>.*<\/th><td>.*<\/td>(<\/tr>)?/ { if (p) print $0; }
/<\/table>/ { p = 0;}' < "$tmp" | \
	sed 's@</td></tr><tr><th>@\n@; s@<tr><th>@@; s@</th><td>@;@g; s@</td></tr>@@; s@</td>@@; s@<!-- @@; s@ -->@@;' | \
	grep -Ev '&nbsp;|Cancelled' | \
	gawk -F \; '{ 
		delete models;
		delete ids;
		models[0] = $1;
		ids[0] = $2;
		if (match($2, "(.*)/(.*)/(.*)", a)) {
			ids[0] = a[1];
			ids[1] = a[2];
			ids[2] = a[3];
		} else
		if (match($2, "(.*)/(.*)", a)) {
			ids[0] = a[1];
			ids[1] = a[2];
		}
		if (match($1, "(.*)-([^-]*)/(.*)", a)) {
			models[0] = a[1]"-"a[2];
			models[1] = a[1]"-"a[3];
		}
        /* New ID */
        if (length(models[0]) == 14) {
            sms = ", F_SUBMIT_SIM_ONLY";
        } else {
            sms = "";
        }
        if (models[0] == "FAE-1021011-BV") {
            sms = sms", F_SMS_LOCATION_0";
        }
		if (length(models) == 2 && length(ids) == 2) {
				print "\t{\""ids[0]"\",\t\""models[0]"\" ,\"\",\t\t\t\t   {F_OBEX"sms", 0}},"; 
				print "\t{\""ids[1]"\",\t\""models[1]"\" ,\"\",\t\t\t\t   {F_OBEX"sms", 0}},"; 
		} else {
			/* Restore IDs, we need to have unique model */
			if (length(models) == 1) {
				delete ids;
				ids[0] = $2;
			}
			for (model in models) {
				for (id in ids) {
					print "\t{\""ids[id]"\",\t\""models[model]"\" ,\"\",\t\t\t\t   {F_OBEX"sms", 0}},"; 
				}
			}
		}
	}'
